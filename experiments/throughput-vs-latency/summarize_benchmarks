#!/usr/bin/python3
from datetime import datetime, time
from operator import itemgetter
import os
import sys
import json
import argparse
import subprocess as sp
import matplotlib.pyplot as plt
import matplotlib.offsetbox as offsetbox
import numpy as np
import math
import pandas as pd
import csv


def count_csv_entries(csv_files):
    return pd.concat([pd.read_csv(file) for file in csv_files]).shape[0]

def count_csv_entries_in_directory(directory, filter):
    csv_files = [file for file in os.listdir(directory) if file.endswith('.csv') and filter in file]
    return pd.concat([pd.read_csv(os.path.join(directory, file)) for file in csv_files]).shape[0]

def compute_throughput(directory, filter, exp_duration):
    print(round(count_csv_entries_in_directory(directory, filter) / exp_duration / 1000, 2))

def concatenate_csv_files(directory, filter, result_file):
    csv_files = [os.path.join(directory, file) for file in os.listdir(directory) if file.endswith('.csv') and filter in file]
    with open(result_file, 'w') as f:
        for csv_file in csv_files:
            with open(csv_file) as f_in:
                for line in f_in:
                    f.write(line)

def compute_csv_percentile(csv_file, column_ix, percentile):
    return pd.read_csv(csv_file).iloc[:, column_ix].quantile(q=percentile)

def add_throughput_latency_row(directory, slog, throughput_append, throughput_read, result_file):
    write_header = not os.path.exists(result_file)
    with open(result_file, 'a', encoding='UTF8', newline='') as f:
        writer = csv.writer(f)
        if write_header:
            writer.writerow(['slog', 'throughput_append', 'throughput_read', 'latency_append_50','latency_append_99', 'latency_read_50','latency_read_99'])
        data = [
            slog,
            throughput_append,
            throughput_read,
            int(compute_csv_percentile(os.path.join(directory, "all-latencies-append.csv".format(slog)), 0, 0.5)),
            int(compute_csv_percentile(os.path.join(directory, "all-latencies-append.csv".format(slog)), 0, 0.99)),
            int(compute_csv_percentile(os.path.join(directory, "all-latencies-read.csv".format(slog)), 0, 0.5)),
            int(compute_csv_percentile(os.path.join(directory, "all-latencies-read.csv".format(slog)), 0, 0.99))
        ]
        writer.writerow(data)


def generate_throughput_vs_latency_plot_append(csv_file, result_file):
    df = pd.read_csv(csv_file)
    df_boki = df.loc[df['slog'] == 'boki-local']
    df_indilog = df.loc[df['slog'] == 'indilog-local']

    fig = plt.figure()
    ax = plt.subplot(111)

    df_boki.plot.line(x='throughput_append', y='latency_append_50', label='Boki-Local Append 0.5', color='steelblue', style='o-', ax=ax)
    df_boki.plot.line(x='throughput_append', y='latency_append_99', label='Boki-Local Append 0.99', color='darkblue', style='o-', ax=ax)
    df_indilog.plot.line(x='throughput_append', y='latency_append_50', label='Indilog-Local Append 0.5', color='lightgreen', style='o-', ax=ax)
    df_indilog.plot.line(x='throughput_append', y='latency_append_99', label='Indilog-Local Append 0.99', color='darkgreen', style='o-', ax=ax)

    plt.xlabel('Throughput (kOp/s)')
    plt.ylabel('Latency (\u03BCs)')

    plt.savefig(result_file)
    plt.close

def generate_throughput_vs_latency_plot_read_local(csv_file, result_file):
    df = pd.read_csv(csv_file)
    df_boki = df.loc[df['slog'] == 'boki-local']
    df_indilog = df.loc[df['slog'] == 'indilog-local']

    fig = plt.figure()
    ax = plt.subplot(111)

    df_boki.plot.line(x='throughput_read', y='latency_read_50', label='Boki-Local Read 0.5', color='steelblue', style='o-', ax=ax)
    df_boki.plot.line(x='throughput_read', y='latency_read_99', label='Boki-Local Read 0.99', color='darkblue', style='o-', ax=ax)
    df_indilog.plot.line(x='throughput_read', y='latency_read_50', label='Indilog-Local Read 0.5', color='lightgreen', style='o-', ax=ax)
    df_indilog.plot.line(x='throughput_read', y='latency_read_99', label='Indilog-Local Read 0.99', color='darkgreen', style='o-', ax=ax)

    plt.xlabel('Throughput (kOp/s)')
    plt.ylabel('Latency (\u03BCs)')

    plt.savefig(result_file)
    plt.close

def generate_throughput_vs_latency_plot_read_remote(csv_file, result_file):
    df = pd.read_csv(csv_file)
    df_boki = df.loc[df['slog'] == 'boki-remote']
    df_indilog = df.loc[df['slog'] == 'indilog-remote']
    df_indilog_point = df.loc[df['slog'] == 'indilog-remote-point']

    fig = plt.figure()
    ax = plt.subplot(111)

    df_boki.plot.line(x='throughput_read', y='latency_read_50', label='Boki-Remote Read 0.5', color='steelblue', style='o-', ax=ax)
    df_boki.plot.line(x='throughput_read', y='latency_read_99', label='Boki-Remote Read 0.99', color='darkblue', style='o-', ax=ax)
    df_indilog.plot.line(x='throughput_read', y='latency_read_50', label='Indilog-Remote Read 0.5', color='lightgreen', style='o-', ax=ax)
    df_indilog.plot.line(x='throughput_read', y='latency_read_99', label='Indilog-Remote Read 0.99', color='darkgreen', style='o-', ax=ax)
    df_indilog_point.plot.line(x='throughput_read', y='latency_read_50', label='Indilog-Remote Point Read 0.5', color='wheat', style='o-', ax=ax)
    df_indilog_point.plot.line(x='throughput_read', y='latency_read_99', label='Indilog-Remote Point Read 0.99', color='darkorange', style='o-', ax=ax)

    plt.xlabel('Throughput (kOp/s)')
    plt.ylabel('Latency (\u03BCs)')

    plt.savefig(result_file)
    plt.close

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('cmd', type=str)
    parser.add_argument('--directory', type=str)
    parser.add_argument('--file', type=str)
    parser.add_argument('--slog', type=str)
    parser.add_argument('--exp-duration', type=int)
    parser.add_argument('--interval', type=int)
    parser.add_argument('--filter', type=str)
    parser.add_argument('--throughput-read', type=float)
    parser.add_argument('--throughput-append', type=float)
    parser.add_argument('--result-file', type=str)
    parser.add_argument('--result-directory', type=str)
    args = parser.parse_args()
    try:
        if args.cmd == 'compute-throughput':
            compute_throughput(args.directory, args.filter, args.exp_duration)
        elif args.cmd == 'concatenate-csv':
            concatenate_csv_files(args.directory, args.filter, args.result_file)
        elif args.cmd == 'add-row':
            add_throughput_latency_row(args.directory, args.slog, args.throughput_append, args.throughput_read, args.result_file)
        elif args.cmd == 'generate-plot-append':
            generate_throughput_vs_latency_plot_append(args.file, args.result_file)
        elif args.cmd == 'generate-plot-read-local':
            generate_throughput_vs_latency_plot_read_local(args.file, args.result_file)
        elif args.cmd == 'generate-plot-read-remote':
            generate_throughput_vs_latency_plot_read_remote(args.file, args.result_file)
        else:
            raise Exception('Unknown command: ' + args.cmd)
    except Exception as e:
        err_str = str(e)
        if not err_str.endswith('\n'):
            err_str += '\n'
        sys.stderr.write(err_str)
        sys.exit(1)